@page "/myrecords"
@using AttendanceWeb.Models
@using AttendanceWeb.Services
@inject AttendanceDatabase Database
@inject FingerprintApiClient ApiClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>My Attendance Records</PageTitle>

<div class="records-container">
    <div class="records-header">
        <button class="btn-back" @onclick='() => Navigation.NavigateTo("/attendance")'>
            ‚Üê Back to Attendance
        </button>
        <h1 class="page-title">üìä My Attendance Records</h1>
        <p class="page-subtitle">View your attendance history</p>
    </div>

    @if (identifiedStudent == null && !isIdentifying)
    {
        <div class="verify-section">
            <div class="verify-card">
                <div class="verify-icon">üîê</div>
                <h2>Verify Your Identity</h2>
                <p>Please scan your fingerprint to view your attendance records</p>
                
                @if (!string.IsNullOrEmpty(fingerprintImage))
                {
                    <div class="fingerprint-preview">
                        <img src="data:image/png;base64,@fingerprintImage" alt="Fingerprint" />
                    </div>
                }
                else
                {
                    <div class="fingerprint-placeholder">
                        <div class="scanner-animation"></div>
                        <p>Ready to scan...</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">‚ö†Ô∏è @errorMessage</div>
                }

                <button class="btn btn-primary" @onclick="VerifyIdentity" disabled="@isIdentifying">
                    @(isIdentifying ? "Scanning..." : "üëÜ Scan Fingerprint")
                </button>
            </div>
        </div>
    }
    else if (identifiedStudent != null)
    {
        <div class="student-info-card">
            <div class="student-avatar">@GetInitials(identifiedStudent.Name)</div>
            <div class="student-details">
                <h2>@identifiedStudent.Name</h2>
                <p>@identifiedStudent.StudentId ‚Ä¢ @identifiedStudent.Program Year @identifiedStudent.YearLevel</p>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>Filter by Event</label>
                <select @bind="selectedEventId" @bind:after="LoadStudentRecords" class="form-control">
                    <option value="0">-- All Events --</option>
                    @foreach (var evt in availableEvents)
                    {
                        <option value="@evt.Id">@evt.EventName (@evt.Period - @evt.AcademicYear)</option>
                    }
                </select>
            </div>
            
            <button class="btn btn-refresh" @onclick="LoadStudentRecords">
                üîÑ Refresh
            </button>
        </div>

        <div class="stats-section">
            <div class="stat-card success">
                <div class="stat-icon">‚úì</div>
                <div class="stat-content">
                    <div class="stat-value">@totalPresent</div>
                    <div class="stat-label">Times Present</div>
                </div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">‚è∞</div>
                <div class="stat-content">
                    <div class="stat-value">@totalLate</div>
                    <div class="stat-label">Times Late</div>
                </div>
            </div>
            
            <div class="stat-card info">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                    <div class="stat-value">@attendanceRate%</div>
                    <div class="stat-label">Attendance Rate</div>
                </div>
            </div>
        </div>

        <div class="records-section">
            <h3>Attendance History (@studentRecords.Count records)</h3>
            
            @if (isLoading)
            {
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your records...</p>
                </div>
            }
            else if (studentRecords.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h4>No Records Found</h4>
                    <p>You don't have any attendance records yet.</p>
                </div>
            }
            else
            {
                <div class="records-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Date</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in studentRecords.OrderByDescending(r => r.RecordDate))
                            {
                                var evt = availableEvents.FirstOrDefault(e => e.Id == record.EventId);
                                <tr>
                                    <td>
                                        <div class="event-cell">
                                            <strong>@evt?.EventName</strong>
                                            <small>@evt?.Period - @evt?.AcademicYear</small>
                                        </div>
                                    </td>
                                    <td>@record.RecordDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (record.TimeIn != null)
                                        {
                                            <span class="time-badge time-in">
                                                ‚Üì @record.TimeIn.Value.ToString("hh:mm tt")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="no-record">--</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.TimeOut != null)
                                        {
                                            <span class="time-badge time-out">
                                                ‚Üë @record.TimeOut.Value.ToString("hh:mm tt")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="no-record">--</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="status-badge @GetStatusClass(record)">
                                            @GetStatus(record, evt)
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

<style>
    .records-container {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
        padding: var(--space-6);
    }

    .records-header {
        text-align: center;
        color: white;
        margin-bottom: var(--space-6);
    }

    .btn-back {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        margin-bottom: var(--space-4);
        transition: all var(--transition-base);
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: var(--space-2);
    }

    .page-subtitle {
        font-size: 1.125rem;
        opacity: 0.95;
    }

    .verify-section {
        max-width: 500px;
        margin: 0 auto;
    }

    .verify-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-8);
        text-align: center;
        box-shadow: var(--shadow-xl);
    }

    .verify-icon {
        font-size: 4rem;
        margin-bottom: var(--space-4);
    }

    .verify-card h2 {
        color: var(--gray-900);
        margin-bottom: var(--space-3);
    }

    .verify-card p {
        color: var(--gray-600);
        margin-bottom: var(--space-6);
    }

    .fingerprint-placeholder {
        width: 200px;
        height: 250px;
        margin: var(--space-6) auto;
        background: var(--gray-100);
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
    }

    .fingerprint-preview {
        margin: var(--space-6) auto;
    }

    .fingerprint-preview img {
        max-width: 200px;
        height: auto;
        border-radius: var(--radius-md);
        border: 2px solid var(--gray-200);
    }

    .scanner-animation {
        width: 60px;
        height: 60px;
        border: 4px solid var(--primary-200);
        border-top-color: var(--primary-600);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .student-info-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        max-width: 1200px;
        margin: 0 auto var(--space-6);
        display: flex;
        align-items: center;
        gap: var(--space-5);
        box-shadow: var(--shadow-xl);
    }

    .student-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    .student-details h2 {
        color: var(--gray-900);
        margin-bottom: var(--space-2);
    }

    .student-details p {
        color: var(--gray-600);
        font-size: 1rem;
    }

    .filter-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        max-width: 1200px;
        margin: 0 auto var(--space-6);
        display: flex;
        gap: var(--space-4);
        align-items: end;
        box-shadow: var(--shadow-lg);
    }

    .filter-group {
        flex: 1;
    }

    .filter-group label {
        display: block;
        color: var(--gray-700);
        font-weight: 600;
        margin-bottom: var(--space-2);
    }

    .form-control {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: 1rem;
    }

    .btn-refresh {
        padding: var(--space-3) var(--space-4);
        background: var(--primary-600);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        transition: all var(--transition-base);
    }

    .btn-refresh:hover {
        background: var(--primary-700);
    }

    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-5);
        max-width: 1200px;
        margin: 0 auto var(--space-6);
    }

    .stat-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        display: flex;
        align-items: center;
        gap: var(--space-4);
        box-shadow: var(--shadow-lg);
    }

    .stat-card.success {
        border-left: 4px solid var(--success-500);
    }

    .stat-card.warning {
        border-left: 4px solid var(--warning-500);
    }

    .stat-card.info {
        border-left: 4px solid var(--primary-500);
    }

    .stat-icon {
        font-size: 2.5rem;
        flex-shrink: 0;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--gray-900);
        line-height: 1;
        margin-bottom: var(--space-2);
    }

    .stat-label {
        color: var(--gray-600);
        font-size: 0.875rem;
        font-weight: 600;
    }

    .records-section {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        max-width: 1200px;
        margin: 0 auto;
        box-shadow: var(--shadow-xl);
    }

    .records-section h3 {
        color: var(--gray-900);
        margin-bottom: var(--space-5);
        font-size: 1.5rem;
    }

    .loading, .empty-state {
        text-align: center;
        padding: var(--space-8);
        color: var(--gray-600);
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--gray-200);
        border-top-color: var(--primary-600);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-4);
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: var(--space-3);
    }

    .records-table {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--gray-50);
    }

    th {
        padding: var(--space-4);
        text-align: left;
        font-weight: 700;
        color: var(--gray-700);
        border-bottom: 2px solid var(--gray-200);
    }

    td {
        padding: var(--space-4);
        border-bottom: 1px solid var(--gray-200);
    }

    tr:hover {
        background: var(--gray-50);
    }

    .event-cell strong {
        display: block;
        color: var(--gray-900);
        margin-bottom: var(--space-1);
    }

    .event-cell small {
        color: var(--gray-600);
        font-size: 0.875rem;
    }

    .time-badge {
        display: inline-block;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .time-badge.time-in {
        background: var(--success-100);
        color: var(--success-700);
    }

    .time-badge.time-out {
        background: var(--error-100);
        color: var(--error-700);
    }

    .no-record {
        color: var(--gray-400);
    }

    .status-badge {
        display: inline-block;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .status-badge.present {
        background: var(--success-100);
        color: var(--success-700);
    }

    .status-badge.late {
        background: var(--warning-100);
        color: var(--warning-700);
    }

    .status-badge.absent {
        background: var(--error-100);
        color: var(--error-700);
    }

    .alert {
        padding: var(--space-4);
        border-radius: var(--radius-md);
        margin: var(--space-4) 0;
    }

    .alert-error {
        background: var(--error-100);
        color: var(--error-700);
        border: 1px solid var(--error-200);
    }

    .btn {
        padding: var(--space-3) var(--space-6);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .btn-primary {
        background: var(--primary-600);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--primary-700);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    @@media (max-width: 768px) {
        .records-container {
            padding: var(--space-4);
        }

        .page-title {
            font-size: 1.5rem;
        }

        .stats-section {
            grid-template-columns: 1fr;
        }

        .filter-section {
            flex-direction: column;
        }

        .btn-refresh {
            width: 100%;
        }

        .student-info-card {
            flex-direction: column;
            text-align: center;
        }

        .records-table {
            font-size: 0.875rem;
        }

        th, td {
            padding: var(--space-2);
        }
    }
</style>

@code {
    private Student? identifiedStudent;
    private List<AttendanceRecord> studentRecords = new();
    private List<Event> availableEvents = new();
    private string fingerprintImage = "";
    private string errorMessage = "";
    private bool isIdentifying = false;
    private bool isLoading = false;
    private int selectedEventId = 0;
    private int totalPresent = 0;
    private int totalLate = 0;
    private int attendanceRate = 0;

    protected override void OnInitialized()
    {
        availableEvents = Database.GetAllEvents();
    }

    private async Task VerifyIdentity()
    {
        isIdentifying = true;
        errorMessage = "";
        fingerprintImage = "";
        StateHasChanged();

        try
        {
            var captureResponse = await ApiClient.CaptureAsync();

            if (!captureResponse.Success || string.IsNullOrEmpty(captureResponse.Template))
            {
                errorMessage = captureResponse.Message;
                return;
            }

            fingerprintImage = captureResponse.ImageData ?? "";
            StateHasChanged();

            var student = await IdentifyStudentAsync(captureResponse.Template);

            if (student == null)
            {
                errorMessage = "Student not recognized. Please enroll your fingerprint first.";
                return;
            }

            identifiedStudent = student;
            await LoadStudentRecords();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isIdentifying = false;
            StateHasChanged();
        }
    }

    private async Task<Student?> IdentifyStudentAsync(string capturedTemplate)
    {
        var allStudentTemplates = Database.GetAllStudentTemplates();

        foreach (var (studentId, templates) in allStudentTemplates)
        {
            foreach (var template in templates)
            {
                var response = await ApiClient.CompareTemplatesAsync(capturedTemplate, template.TemplateData);
                if (response.Success)
                {
                    return Database.GetStudent(studentId);
                }
            }
        }

        return null;
    }

    private async Task LoadStudentRecords()
    {
        if (identifiedStudent == null) return;

        isLoading = true;
        StateHasChanged();

        await Task.Delay(100);

        // Get all attendance records for this student
        var allRecords = Database.GetAllAttendanceRecords()
            .Where(r => r.StudentId == identifiedStudent.Id)
            .ToList();

        if (selectedEventId == 0)
        {
            studentRecords = allRecords;
        }
        else
        {
            studentRecords = allRecords
                .Where(r => r.EventId == selectedEventId)
                .ToList();
        }

        CalculateStats();

        isLoading = false;
        StateHasChanged();
    }

    private void CalculateStats()
    {
        totalPresent = studentRecords.Count(r => r.TimeIn != null);
        totalLate = studentRecords.Count(r => r.TimeIn != null && IsLate(r));
        
        var totalEvents = selectedEventId == 0 
            ? availableEvents.Count(e => e.EventDate <= DateTime.Now)
            : 1;

        attendanceRate = totalEvents > 0 ? (totalPresent * 100) / totalEvents : 0;
    }

    private bool IsLate(AttendanceRecord record)
    {
        var evt = availableEvents.FirstOrDefault(e => e.Id == record.EventId);
        if (evt == null || record.TimeIn == null || string.IsNullOrEmpty(evt.TimeInEnd))
            return false;

        if (TimeSpan.TryParse(evt.TimeInEnd, out var timeInEnd))
        {
            return record.TimeIn.Value.TimeOfDay > timeInEnd;
        }

        return false;
    }

    private string GetStatus(AttendanceRecord record, Event? evt)
    {
        if (record.TimeIn == null)
            return "Absent";

        return IsLate(record) ? "Late" : "Present";
    }

    private string GetStatusClass(AttendanceRecord record)
    {
        if (record.TimeIn == null)
            return "absent";

        return IsLate(record) ? "late" : "present";
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return name.Length > 0 ? name[0].ToString().ToUpper() : "?";
    }
}
