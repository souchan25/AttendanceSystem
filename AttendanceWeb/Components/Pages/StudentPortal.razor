@page "/"
@page "/student"
@using AttendanceWeb.Models
@using AttendanceWeb.Services
@inject AttendanceDatabase Database
@inject FingerprintApiClient ApiClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@layout AttendanceWeb.Components.Layout.StudentLayout
@rendermode InteractiveServer

<PageTitle>Student Portal</PageTitle>

<div class="portal-container">
    <div class="portal-header-bar">
        <div class="header-branding">
            <div class="logo-icon">üéì</div>
            <div>
                <h1 class="portal-title">Student Attendance Portal</h1>
                <p class="portal-subtitle">Select an event to check your attendance</p>
            </div>
        </div>
        <div class="header-controls">
            @if (isReinitializing)
            {
                <div class="status-msg">Reinitializing...</div>
            }
            <button class="btn-reinit" @onclick="ReinitializeScanner" disabled="@isReinitializing" title="Reinitialize Scanner">
                <span>Scan Fix</span>
                <span style="font-size: 1.2em">üîÑ</span>
            </button>
            <button class="btn-fullscreen" @onclick="ToggleFullscreen" title="Fullscreen Mode">
                ‚õ∂
            </button>
        </div>
    </div>

    <div class="portal-body">
        <div class="events-section">
            <div class="section-header-simple">
                <h2>Active Events</h2>
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading active events...</p>
                </div>
            }
            else if (activeEvents.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>No Active Events</h3>
                    <p>There are no ongoing events at the moment.</p>
                    <p class="hint">Please check back later or contact your administrator.</p>
                </div>
            }
            else
            {
                <div class="events-grid">
                    @foreach (var evt in activeEvents)
                    {
                        <div class="event-card" @onclick="() => SelectEvent(evt.Id)">
                            <div class="event-header">
                                <div class="event-icon">üóìÔ∏è</div>
                                @if (evt.IsActive)
                                {
                                    <div class="event-status">
                                        <span class="status-dot"></span> Active
                                    </div>
                                }
                            </div>
                            
                            <div class="event-content">
                                <h3>@evt.EventName</h3>
                                
                                <div class="event-details">
                                    <span class="detail-item" title="Period">
                                        <span class="icon">üìñ</span> @evt.Period
                                    </span>
                                    <span class="detail-item" title="Academic Year">
                                        <span class="icon">üìÖ</span> @evt.AcademicYear
                                    </span>
                                </div>

                                <div class="event-date">
                                    <span class="icon">üóìÔ∏è</span> @evt.EventDate.ToString("MMMM dd, yyyy")
                                </div>

                                @if (!string.IsNullOrEmpty(evt.Description))
                                {
                                    <p class="event-description">@evt.Description</p>
                                }

                                <div class="time-info">
                                    <div class="time-slot">
                                        <span class="time-label">‚¨á Time In:</span>
                                        <span class="time-range">
                                            @(evt.TimeInStart?.ToString("hh:mm tt") ?? "--") - 
                                            @(evt.TimeInEnd?.ToString("hh:mm tt") ?? "--")
                                        </span>
                                    </div>
                                    <div class="time-slot">
                                        <span class="time-label">‚¨Ü Time Out:</span>
                                        <span class="time-range">
                                            @(evt.TimeOutStart?.ToString("hh:mm tt") ?? "--") - 
                                            @(evt.TimeOutEnd?.ToString("hh:mm tt") ?? "--")
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="event-footer">
                                <button class="btn-select">Select Event ‚ûú</button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <aside class="instruction-sidebar">
            <div class="instruction-card">
                <div class="instruction-header">
                    <div class="info-icon">üí°</div>
                    <h4>Instructions</h4>
                </div>
                <div class="steps-list">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-text">Select an <strong>active event</strong> from the list on the left.</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-text">Check the <strong>Time In</strong> and <strong>Time Out</strong> schedule.</div>
                    </div>
                     <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-text">Place your finger on the <strong>scanner</strong> when prompted.</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div>
                        <div class="step-text">Wait for the <strong>confirmation message</strong>.</div>
                    </div>
                </div>
            </div>
            
            <div class="system-status-card">
                 <h4>System Status</h4>
                 <div class="status-row">
                     <span>Scanner:</span>
                     <span class="status-badge ready">Ready</span>
                 </div>
                 <div class="status-row">
                     <span>Network:</span>
                     <span class="status-badge online">Online</span>
                 </div>
            </div>
        </aside>
    </div>
</div>

<style>
    .portal-container {
        position: relative;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
        padding: var(--space-4);
    }

    .header-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .portal-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        padding: var(--space-2) var(--space-2);
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-xl);
        padding: var(--space-3) var(--space-5);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header-branding {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    
    .logo-icon {
        font-size: 2rem;
        background: white;
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        color: var(--primary-600);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .status-msg { background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; color: white; border: 1px solid rgba(255,255,255,0.2); }
    
    .btn-reinit, .btn-fullscreen {
        background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
        display: flex; align-items: center; gap: 8px; transition: all 0.2s;
    }
    .btn-reinit:hover:not(:disabled), .btn-fullscreen:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-1px); border-color: rgba(255,255,255,0.4); }

    .portal-title {
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0;
        letter-spacing: -0.5px;
        color: white;
    }

    .portal-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
    }

    .portal-body {
        flex: 1;
        display: flex;
        gap: var(--space-5);
        min-height: 0; 
        overflow: hidden;
    }

    /* LEFT SIDE: EVENTS */
    .events-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
        min-width: 0;
    }
    
    .section-header-simple {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 var(--space-2);
        margin-bottom: -8px; /* Visual tightening */
    }
    
    .section-header-simple h2 {
        color: white;
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        opacity: 0.95;
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        background: rgba(239, 68, 68, 0.2);
        padding: 4px 10px;
        border-radius: 20px;
        border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        box-shadow: 0 0 10px #ef4444;
        animation: pulse-red 1.5s infinite;
    }

    @@keyframes pulse-red {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
        100% { opacity: 1; transform: scale(1); }
    }

    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* More compact cards to fit 3 in row */
        grid-auto-rows: max-content; /* THIS FIXES THE STRETCHING */
        gap: var(--space-4);
        overflow-y: auto;
        padding-right: var(--space-2);
        padding-bottom: var(--space-4); /* Bottom padding for scroll */
    }
    
    /* Scrollbar */
    .events-grid::-webkit-scrollbar { width: 6px; }
    .events-grid::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .events-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    .events-grid::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

    .event-card {
        background: white;
        border-radius: 24px; /* More rounded */
        padding: 0; /* Removing padding to use inner spacing */
        display: flex;
        flex-direction: column;
        gap: 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        height: auto; /* Allow natural height */
    }

    .event-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .event-header { 
        padding: 24px 24px 0 24px;
        display: flex; justify-content: space-between; align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .event-icon { 
        font-size: 1.75rem; 
        background: var(--primary-50); 
        width: 56px; height: 56px; 
        display: flex; align-items: center; justify-content: center; 
        border-radius: 16px; 
        color: var(--primary-600);
    }
    
    .event-status {
        background: #ecfdf5; color: #059669; 
        padding: 6px 12px; border-radius: 20px;
        border: 1px solid #d1fae5;
    }
    
    .event-content { padding: 0 24px; flex: 1; }

    .event-content h3 { font-size: 1.25rem; color: var(--neutral-900); margin: 0 0 12px 0; letter-spacing: -0.025em; }
    
    .event-details { display: flex; gap: 16px; font-size: 0.85rem; color: var(--neutral-600); margin-bottom: 20px; }
    .detail-item { background: var(--neutral-50); padding: 4px 10px; border-radius: 8px; font-weight: 600; }
    
    .event-date { color: var(--primary-700); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    
    .time-info {
        background: #f8fafc;
        border-radius: 16px;
        padding: 16px;
        margin-top: 20px;
        border: 1px solid var(--neutral-100);
    }
    .time-slot { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .time-slot:last-child { margin-bottom: 0; }
    .time-label { font-weight: 500; color: var(--neutral-500); }
    
    .event-footer {
        padding: 24px;
        margin-top: auto;
    }
    
    .btn-select {
        width: 100%; padding: 14px; background: var(--primary-600); color: white; border: none;
        border-radius: 16px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    }
    .btn-select:hover { background: var(--primary-700); box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3); transform: translateY(-1px); }


    /* RIGHT SIDE: INSTRUCTIONS */
    .instruction-sidebar {
        width: 380px; /* Fixed width for better stability */
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }

    .instruction-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .instruction-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        padding-bottom: 0;
        border-bottom: none;
    }

    .info-icon { 
        font-size: 1.5rem; 
        background: #fffbeb; color: #d97706;
        width: 48px; height: 48px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 4px rgba(217, 119, 6, 0.2);
    }
    .instruction-header h4 { margin: 0; font-size: 1.25rem; color: var(--neutral-800); font-weight: 700; }

    .steps-list { display: flex; flex-direction: column; gap: 20px; }

    .step-item { display: flex; gap: 16px; align-items: flex-start; }

    .step-number {
        background: var(--primary-600); color: white;
        width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
        justify-content: center; font-weight: 700; flex-shrink: 0; font-size: 0.9rem;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
    }

    .step-text { font-size: 0.95rem; color: var(--neutral-700); line-height: 1.6; padding-top: 4px; }
    
    .system-status-card {
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 24px;
        color: white;
        border: 1px solid rgba(255,255,255,0.1);
    }    
    .system-status-card h4 { margin: 0 0 var(--space-3) 0; font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
    
    .status-badge {
        padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    }
    .status-badge.ready { background: #dcfce7; color: #166534; }
    .status-badge.online { background: #dbeafe; color: #1e40af; }
    
    .loading, .empty-state {
        background: white; border-radius: var(--radius-xl); padding: var(--space-8);
        text-align: center; color: var(--neutral-600); display: flex; flex-direction: column;
        align-items: center; justify-content: center; height: 100%;
    }
    .spinner {
        width: 40px; height: 40px; border: 3px solid var(--neutral-200); border-top-color: var(--primary-600);
        border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: var(--space-3);
    }
    @@keyframes spin { to { transform: rotate(360deg); } }

    @@media (max-width: 900px) {
        .portal-body { flex-direction: column; overflow-y: auto; }
        .events-grid { overflow-y: visible; }
        .instruction-sidebar { min-width: auto; max-width: none; }
    }
</style>

@code {
    private List<Event> activeEvents = new();
    private bool isLoading = true;
    private bool isReinitializing = false;
    private string statusMessage = "";
    private bool isFullscreen = false;

    protected override async Task OnInitializedAsync()
    {
        // Auto-refresh scanner on load
        _ = ReinitializeScanner();
        await LoadActiveEvents();
    }

    private async Task ReinitializeScanner()
    {
        isReinitializing = true;
        statusMessage = "Initializing...";
        StateHasChanged();

        var result = await ApiClient.ReinitializeAsync();
        
        if (result.Success)
        {
            statusMessage = "Scanner Ready!";
        }
        else
        {
            statusMessage = "Failed: " + (result.Message ?? result.Error);
        }

        isReinitializing = false;
        StateHasChanged();

        await Task.Delay(3000);
        statusMessage = "";
        StateHasChanged();
    }

    private async Task LoadActiveEvents()
    {
        isLoading = true;
        StateHasChanged();

        await Task.Delay(100); // Small delay for smooth UI

        activeEvents = Database.GetActiveEvents()
            .OrderByDescending(e => e.EventDate)
            .ToList();

        isLoading = false;
        StateHasChanged();
    }

    private void SelectEvent(int eventId)
    {
        Navigation.NavigateTo($"/attendance?eventId={eventId}");
    }

    private async Task ToggleFullscreen()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("toggleFullscreen");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fullscreen error: {ex.Message}");
            statusMessage = "Fullscreen not supported. Press F11 key.";
            StateHasChanged();
            await Task.Delay(3000);
            statusMessage = "";
            StateHasChanged();
        }
    }
}
