@page "/attendance"
@using AttendanceWeb.Models
@using AttendanceWeb.Services
@using Microsoft.AspNetCore.Components
@inject AttendanceDatabase Database
@inject FingerprintApiClient ApiClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Attendance Portal</PageTitle>

<div class="attendance-container">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="btn btn-back" @onclick='() => Navigation.NavigateTo("/")'>
                ‚Üê Back to Events
            </button>
            <h1 class="title">üéì ATTENDANCE PORTAL</h1>
            <p class="subtitle">
                @currentEvent?.EventName (@currentEvent?.Period - @currentEvent?.AcademicYear)
                @if (currentEvent != null)
                {
                    <br/>
                    <span style="font-size: 0.8em; opacity: 0.8;">
                        @if(currentEvent.TimeInStart.HasValue) { <span>Time In: @currentEvent.TimeInStart - @currentEvent.TimeInEnd</span> }
                        @if(currentEvent.TimeOutStart.HasValue) { <span style="margin-left: 10px;">Time Out: @currentEvent.TimeOutStart - @currentEvent.TimeOutEnd</span> }
                    </span>
                }
            </p>
        </div>

        <div class="header-right">
            @if (identifiedStudent != null)
            {
                <button class="btn btn-my-records" @onclick='() => Navigation.NavigateTo($"/myrecords/{identifiedStudent.Id}")'>
                    <span class="icon">üìä</span> VIEW RECORDS
                </button>
            }
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="scan-area">
            <div class="instruction">
                <span class="finger-icon">üëÜ</span>
                <h2>@statusMessage</h2>
                <p class="hint">@statusHint</p>
            </div>

            @if (!string.IsNullOrEmpty(fingerprintImage))
            {
                <div class="fingerprint-preview">
                    <img src="data:image/png;base64,@fingerprintImage" alt="Fingerprint" />
                </div>
            }
            else
            {
                <div class="fingerprint-placeholder">
                    <div class="scanner-animation"></div>
                    <p>Waiting for scan...</p>
                </div>
            }

            @if (identifiedStudent != null)
            {
                <div class="student-info @(isTimeIn ? "success" : "warning")">
                    <div class="student-avatar">@GetInitials(identifiedStudent.Name)</div>
                    <div class="student-details">
                        <h3>@identifiedStudent.Name</h3>
                        <p>@identifiedStudent.StudentId ‚Ä¢ @identifiedStudent.Program Year @identifiedStudent.YearLevel</p>
                        <p class="timestamp">‚è±Ô∏è @lastTimestamp</p>
                    </div>
                </div>
            }
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-action btn-time-in" @onclick="HandleTimeIn" disabled="@isScanning">
                <span class="icon">‚Üì</span>
                <span class="label">TIME IN</span>
            </button>
            <button class="btn-action btn-time-out" @onclick="HandleTimeOut" disabled="@isScanning">
                <span class="icon">‚Üë</span>
                <span class="label">TIME OUT</span>
            </button>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span class="@(scannerConnected ? "status-connected" : "status-disconnected")">
            @(scannerConnected ? "‚úì Scanner Connected" : "‚úó Scanner Disconnected")
        </span>
        <span class="clock">üïê @DateTime.Now.ToString("hh:mm:ss tt")</span>
    </div>
</div>

<style>
    .attendance-container {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-900) 100%);
        color: white;
        display: flex;
        flex-direction: column;
        padding: var(--space-5);
    }

    .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: var(--space-5) var(--space-6);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-6);
        box-shadow: var(--shadow-lg);
    }

    .title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: var(--space-1);
        letter-spacing: -0.01em;
    }

    .subtitle {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 400;
    }

    .header-right {
        display: flex;
        gap: var(--space-3);
    }

    .btn {
        padding: var(--space-3) var(--space-4);
        border: none;
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        box-shadow: var(--shadow-sm);
    }

    .btn-back {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-bottom: var(--space-3);
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateX(-3px);
    }

    .btn-reinit {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-right: var(--space-2);
    }

    .btn-reinit:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .btn-my-records {
        background: #10b981;
        color: white;
    }

    .btn-my-records:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-admin {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-admin:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-records {
        background: white;
        color: var(--primary-700);
    }

    .btn-records:hover {
        background: var(--neutral-100);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-6);
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
    }

    .scan-area {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: var(--radius-2xl);
        padding: var(--space-8);
        width: 100%;
        text-align: center;
        box-shadow: var(--shadow-xl);
    }

    .instruction {
        margin-bottom: var(--space-6);
    }

    .finger-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: var(--space-3);
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .instruction h2 {
        font-size: 1.5rem;
        margin-bottom: var(--space-2);
        font-weight: 700;
    }

    .hint {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    .fingerprint-preview {
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--radius-xl);
        padding: var(--space-5);
        margin: var(--space-5) auto;
        max-width: 280px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .fingerprint-preview img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-lg);
    }

    .fingerprint-placeholder {
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-xl);
        padding: var(--space-8);
        margin: var(--space-5) auto;
        max-width: 280px;
        border: 2px dashed rgba(255, 255, 255, 0.3);
    }

    .fingerprint-placeholder p {
        color: rgba(255, 255, 255, 0.8);
        margin: 0;
        font-size: 0.875rem;
    }

    .student-info {
        margin-top: var(--space-6);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        display: flex;
        align-items: center;
        gap: var(--space-4);
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .student-info.success {
        background: rgba(16, 185, 129, 0.2);
        border: 2px solid rgba(16, 185, 129, 0.5);
    }

    .student-info.warning {
        background: rgba(245, 158, 11, 0.2);
        border: 2px solid rgba(245, 158, 11, 0.5);
    }

    @@keyframes slideIn {
        from { 
            transform: translateY(20px); 
            opacity: 0; 
        }
        to { 
            transform: translateY(0); 
            opacity: 1; 
        }
    }

    .student-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    .student-details {
        text-align: left;
        flex: 1;
    }

    .student-details h3 {
        font-size: 1.25rem;
        margin-bottom: var(--space-1);
        font-weight: 600;
    }

    .student-details p {
        font-size: 0.875rem;
        opacity: 0.95;
        margin: var(--space-1) 0;
    }

    .timestamp {
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: var(--space-5);
        margin-top: var(--space-8);
        width: 100%;
    }

    .btn-action {
        flex: 1;
        padding: var(--space-6);
        border: none;
        border-radius: var(--radius-xl);
        font-size: 1.125rem;
        font-weight: 700;
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-3);
        box-shadow: var(--shadow-lg);
    }

    .btn-action .icon {
        font-size: 2rem;
    }

    .btn-time-in {
        background: var(--success-600);
        color: white;
    }

    .btn-time-in:hover:not(:disabled) {
        background: var(--success-700);
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
    }

    .btn-time-out {
        background: var(--error-500);
        color: white;
    }

    .btn-time-out:hover:not(:disabled) {
        background: var(--error-600);
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
    }

    .btn-action:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .status-bar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: var(--space-4) var(--space-6);
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-xl);
        margin-top: var(--space-6);
        font-weight: 500;
    }

    .status-connected {
        color: #4ade80;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .status-disconnected {
        color: #f87171;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .clock {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    @@media (max-width: 768px) {
        .attendance-container {
            padding: var(--space-4);
        }

        .header {
            flex-direction: column;
            gap: var(--space-4);
            padding: var(--space-4);
        }

        .header-right {
            width: 100%;
            justify-content: stretch;
        }

        .header-right .btn {
            flex: 1;
        }

        .main-content {
            padding: var(--space-4);
        }

        .scan-area {
            padding: var(--space-5);
        }

        .action-buttons {
            flex-direction: column;
            gap: var(--space-4);
        }

        .btn-action {
            width: 100%;
        }

        .title {
            font-size: 1.25rem;
        }
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "eventId")]
    public int? EventId { get; set; }

    private Event? currentEvent;
    private Student? identifiedStudent;
    private string statusMessage = "PLACE YOUR FINGER ON THE SCANNER";
    private string statusHint = "Ready to scan fingerprint...";
    private string fingerprintImage = "";
    private bool isScanning = false;
    private bool scannerConnected = false;
    private bool isTimeIn = true;
    private bool showRecordsOption = false;
    private string lastTimestamp = "";
    private System.Threading.Timer? clockTimer;

    protected override async Task OnInitializedAsync()
    {
        await CheckConnection();
        await LoadCurrentEvent();

        // Update clock every second
        clockTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async Task CheckConnection()
    {
        scannerConnected = await ApiClient.CheckConnectionAsync();
    }

    private async Task HandleReinitialize()
    {
        isScanning = true;
        statusMessage = "INITIALIZING...";
        statusHint = "Resetting fingerprint scanner...";
        StateHasChanged();

        var result = await ApiClient.ReinitializeAsync();
        
        if (result.Success)
        {
            await CheckConnection();
            statusMessage = "SCANNER READY";
            statusHint = "Successfully reinitialized";
        }
        else
        {
            statusMessage = "ERROR";
            statusHint = result.Message ?? result.Error ?? "Initialization failed";
            scannerConnected = false;
        }

        isScanning = false;
        StateHasChanged();

        // If success, revert to default message after delay
        if (result.Success)
        {
            await Task.Delay(2000);
            statusMessage = "PLACE YOUR FINGER ON THE SCANNER";
            statusHint = "Ready to scan fingerprint...";
            StateHasChanged();
        }
    }

    private async Task LoadCurrentEvent()
    {
        if (EventId.HasValue && EventId.Value > 0)
        {
            currentEvent = Database.GetEvent(EventId.Value);
            
            if (currentEvent == null)
            {
                // Event not found, redirect back to event selection
                Navigation.NavigateTo("/");
                return;
            }
        }
        else
        {
            // No event selected, redirect to event selection
            Navigation.NavigateTo("/");
            return;
        }
        
        await Task.CompletedTask;
    }

    private async Task HandleTimeIn()
    {
        await PerformAttendanceCheck(true);
    }

    private async Task HandleTimeOut()
    {
        await PerformAttendanceCheck(false);
    }

    private async Task PerformAttendanceCheck(bool timeIn)
    {
        if (isScanning || currentEvent == null) return;

        isScanning = true;
        isTimeIn = timeIn;
        identifiedStudent = null;
        fingerprintImage = "";
        statusMessage = "‚è≥ Please place your finger on the scanner...";
        statusHint = "Capturing fingerprint...";
        StateHasChanged();

        try
        {
            var captureResponse = await ApiClient.CaptureAsync();

            if (!captureResponse.Success || string.IsNullOrEmpty(captureResponse.Template))
            {
                statusMessage = "‚ùå Scan failed";
                statusHint = captureResponse.Message;
                return;
            }

            fingerprintImage = captureResponse.ImageData ?? "";
            statusMessage = "üîç Identifying student...";
            statusHint = "Please wait...";
            StateHasChanged();

            var student = await IdentifyStudentAsync(captureResponse.Template);

            if (student == null)
            {
                statusMessage = "‚ùå Student not recognized";
                statusHint = "Please enroll your fingerprint first";
                return;
            }

            identifiedStudent = student;
            lastTimestamp = DateTime.Now.ToString("hh:mm:ss tt");

            if (timeIn)
            {
                var result = Database.RecordTimeIn(student.Id, currentEvent.Id);
                if (result.Success)
                {
                    statusMessage = $"‚úÖ TIME IN RECORDED";
                    statusHint = $"Welcome, {student.Name}! You can view your records.";
                    showRecordsOption = true;
                }
                else
                {
                    statusMessage = $"‚ùå TIME IN FAILED";
                    statusHint = result.Message;
                    showRecordsOption = false;
                }
            }
            else
            {
                var result = Database.RecordTimeOut(student.Id, currentEvent.Id);
                if (result.Success)
                {
                    statusMessage = $"‚úÖ TIME OUT RECORDED";
                    statusHint = $"Goodbye, {student.Name}! You can view your records.";
                    showRecordsOption = true;
                }
                else
                {
                    statusMessage = $"‚ùå TIME OUT FAILED";
                    statusHint = result.Message;
                    showRecordsOption = false;
                }
            }
        }
        catch (Exception ex)
        {
            statusMessage = "‚ùå Error occurred";
            statusHint = ex.Message;
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
            
            // Auto-clear after 8 seconds to give time to see records option
            await Task.Delay(8000);
            if (identifiedStudent != null)
            {
                identifiedStudent = null;
                fingerprintImage = "";
                showRecordsOption = false;
                statusMessage = "PLACE YOUR FINGER ON THE SCANNER";
                statusHint = "Ready to scan fingerprint...";
                StateHasChanged();
            }
        }
    }

    private async Task<Student?> IdentifyStudentAsync(string capturedTemplate)
    {
        var allStudentTemplates = Database.GetAllStudentTemplates();

        foreach (var (studentId, templates) in allStudentTemplates)
        {
            foreach (var template in templates)
            {
                var response = await ApiClient.CompareTemplatesAsync(capturedTemplate, template.TemplateData);
                if (response.Success)
                {
                    return Database.GetStudent(studentId);
                }
            }
        }

        return null;
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return name.Length > 0 ? name[0].ToString().ToUpper() : "?";
    }

    public void Dispose()
    {
        clockTimer?.Dispose();
    }
}
